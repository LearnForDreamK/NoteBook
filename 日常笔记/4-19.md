重复帖子推荐考量

1.给每个用户建立布隆过滤器，推荐内容使用布隆过滤器过滤一下。

2.给每个贴建立一个观看列表布隆过滤器，里面存放用户id hash的比特位。

3.一个大的布隆过滤器存放所有用户的观看记录，推荐时不在列表中才能推送。

减少误判次数可以考虑增加长度 和 hash次数。

对于存储空间，100万数据 ，误判率5%，需要700万位的空间，大概875k的内存。（hash函数绝对均匀）

1.如果布隆过滤器存储的是用户id，是每个帖子独有的，就无法控制好每个帖子的布隆过滤器大小，因为每个贴子无法预测会有多少人看到，一个固定的值可能会导致误判率大大增加或者空间大量浪费。

2.如果布隆过滤器是每个用户独有的，按每个用户阅览300个帖子，一个月30*300 = 9000条数据，一年也就11万左右的条目。

```java
//
p = 误判率
k = hash函数个数
n = 数据量大小
m = bit数组位数
有以下公式
    k = - lnp/ln2
    m = kn/ln2
```

按上述公式计算

一个用户如果一年一个布隆过滤器,系统保证新一年不推荐上一年的帖子，%5误判率，hash函数个数为5的条件下

存储的比特位

```sql
 m = 5*110000/ln2  = 80万位 = 98kb 
```

一个用户一年需要一个固定98KB大小的布隆过滤器保证推荐不重复。100万用户需要

```sql
1000000X98/1024/1024 = 93GB
```

的空间保证推荐不重复。 如果只保证一个用户一个月的推荐不重复，空间可以压缩到

```sql
8KB X 1000000/1024/1024 = 7.6GB
```

保证1000万用户每个月推荐不重复需要76GB空间。 

保证一个用户一个星期的推荐不重复需要

```sql
2100*5/ln2/8/1024 = 1.85kb 
```

 空间，1000万用户需要17.6GB的空间。



##### 具体操作

可以给每个用户维护一个布隆过滤器，保存用户一周的帖子推荐记录，通过贴吧的经验，帖子下面可以有一个小按钮反馈推荐重复，如果用户在一个周期点了三次这个按钮，就可以推断布隆过滤器快满了，就直接更新布隆过滤器和推荐规则。  个人感觉折中的方案是推荐只能推荐**上次跟新布隆过滤器昨天-下次更新前天**的帖子，每次更新布隆过滤器的时候，就更新推荐起始位为昨天，只能推荐昨天到目前的帖子。

 比如下面，黑色的是更新布隆过滤器的时间点，b c d e f g h这个时间段可以拿到a-g这个时间端的帖子，h阶段的帖子无法拿到。

a b c d e f       g h  i  j

7 **1** 2 3 4 5      6 7 **1** 2



可能要考虑的问题：

- 对于用户id的hash函数应该怎么样选取保证hash分布足够均匀。（现在只能考虑自带的hash函数通过抖动产生多个hash函数）

- 应该需要多少hash函数。误判率多少合适，%5感觉已经足够。

- 布隆过滤器过滤周期的选择，以多少时间为一个周期。

- 布隆过滤器更新时，如何保证推荐不重复。（上述的方案比较折中）。

- 用户量较少的情况下，可以把布隆过滤器大小调大，然后中转周期可以拉长，预留更多的时间给更新布隆过滤器时推荐的帖子选择。

  





完善了用户发布的帖子列表，用户点赞的帖子列表，他人发布的帖子列表，他人点赞的帖子列表，关注用户，取关用户，点赞帖子，取消点赞帖子，点赞评论，取消点赞评论的接口文档。 完成了点赞相关接口的实现，并进行了单元测试。

