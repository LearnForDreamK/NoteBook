[TOC]

# 分布式一致性协议

在分布式系统中，节点之间主要使用消息投递方式来完成。但通过消息投递的方式会遇到很多意外的情况，例如网络问题、进程挂掉、机器挂掉、进程很慢没有响应、进程重启等情况，这就会造成消息重复、一段时间内部不可达等现象。Paxos算法的作用就是在可能发生这些异常情况的分布式系统中，快速且正确地在集群内部对某个数据的值达成一致。

## 一.Paxos协议

### 1.拜占庭问题

> 拜占庭帝国有许多支军队，不同军队的将军之间必须制订一个统一的行动计划，从而做出进攻或者撤退的决定，同时，各个将军在地理上都是被分隔开来的，只能依靠军队的通讯员来进行通讯。然而，在所有的通讯员中可能会存在叛徒，这些叛徒可以任意篡改消息，从而达到欺骗将军的目的。

Paxos算法前提是保证不出现拜占庭问题，这由其他方式保证（校验/硬件）。

### 2.基本想法

paxos是一个希腊城邦，城邦里的所有决议是选举投票制，城邦里只有三种人，Proposer(提议者)，Acceptor(接收者)，Learner(学习者)。不定时进行投票，最终达成一致性决议。

规定一个提议包含两个字段（N，V），N是唯一序号，V是提议值。

#### 1）大概过程

1.提议者向所有接收者发送自己的提议。
2.接收者收到提议后，如果接收者没收到提议过，则回复一个提议响应（尚无提案），设置当前收到的提议，并设置不再接收序号小于N的提议。
3.如果接收者之前收到过提议，则根据提议的序号判断，如果序号小于当前已有提议的序号，则直接丢弃，如果大于已有提议的序号，则移除已有的提议作为提议响应（之前的提议）返回，保证不再接收序号小于当前提议序号的提议。
4.当提议者收到超过一半接收者的提议响应后，则可以发送接受请求，接收请求的V值会取该提议者收到的提议响应中最大的V。
5.接收者收到接受请求后，如果序号大于当前本地提议的序号，则发送通知给所有学习者，否则直接丢弃提议。
6.当学习者发现大多数的接收者接受了某个提议，那么这个提议就被Paxos选举出来。

### 3.引用

> Paxos：https://www.cnblogs.com/crazymakercircle/p/14341015.html
> Paxos讨论：https://blog.csdn.net/lin819747263/article/details/106313936
>
> 包含推导过程
> 2021/7/18补充：https://www.cnblogs.com/linbingdong/p/6253479.html

## 二.ZAB协议

Zookeeper的核心是原子广播，这个机制保证了各个Server之间的同步。实现这个机制的协议叫做Zab协议。Zab协议 的全称是 **Zookeeper Atomic Broadcast** （Zookeeper原子广播）。**Zookeeper 是通过 Zab 协议来保证分布式事务的最终一致性**。ZAB主要用于构建高可用分布式系统，Paxos 算法用于构建一致性状态机器。所有会有细微差别。但是ZAB就是在Paxos保证一致性基础上设计出高可用的协议。

具体查看之前的zookeeper总结。

#### 引用

> ZAB协议：https://www.cnblogs.com/crazymakercircle/p/14339702.html
>
> ZAB（特别好）：https://dbaplus.cn/news-141-1875-1.html
>
> ZK解决脑裂（过半投票）：https://www.cnblogs.com/kevingrace/p/12433503.html
>
> ZK内的队列：https://juejin.cn/post/6844903895160897550



## 三.RAFT协议

> `Raft 算法`是分布式系统开发首选的`共识算法`。比如现在流行 Etcd、Consul、Nacos。如果`掌握`了这个算法，就可以较容易地处理绝大部分场景的`容错`和`一致性`需求。比如分布式配置系统、分布式 NoSQL 存储等等，轻松突破系统的单机限制。
>
> **Raft 算法是通过一切以领导者为准的方式，实现一系列值的共识和各节点日志的一致。**

#### 1.角色

##### 1）Leader

处理写请求、管理日志复制和不断地发送心跳信息。

##### 2）Candidate

向其他节点请求投票RPC消息（Redis协议？），通知其他节点投票，如果获得大多数选票则成为Leader。

##### 3）Follower

接收leader消息，当leader心跳超时，主动称为candidate。

#### 2.基础概念

##### 1）任期特性

###### ①自增


每个节点都有一个任期（Term），跟随着在等待leader心跳信息超时后，推荐自己为候选人，增加自己任期号。

###### ②更新较大值

当节点发现自己任期号比其他节点小，会更新为较大的编号值，比如一个节点投票，任期为2，另一个节点收到消息后会把自己任期号更新为2。

###### ③错误恢复

如果一个candidate或leader发现自己任期比其他节点小，会立刻恢复为follower。（出现分区错误时会有这种情况）

###### ④拒绝消息

如果一个节点收到任期编号比自己小的请求，会直接拒绝。

###### ⑤其他

一次选举中，每个服务器最多对一个任期编号投票，投完就不会再投。



##### 2）补充知识

为了防止多个节点同时发起投票，会给每个节点分配一个随机的选举超时时间。这个时间内，节点不能成为候选者，只能等到超时。 这大大减少了选票被瓜分而导致的选举失败的情况。



每个节点等待Leader心跳的超时时间间隔都是随机的（超时时间是统一的，只是等待间隔不同）。

#### 3.过程

1.发起投票，初始化时某节点率先成为candidate，增加自己任期编号，给自己投票，并向其他节点发送请求投票信息。

2.其他节点接到请求后，如果在票中给出的任期内没投过票，则投票，然后增加自己任期编号。

3.如果一个发起投票的节点得到包含自己在内大多数选票，则成为当前任期的leader，给其他节点发送心跳信息。

#### 4.关键机制

- 任期
- 领导者心跳信息
- 随机选举超时时间
- 先来先服务的投票原则
- 大多数选票原则

#### 5.日志

日志复制可以说是Raft集群的核心之一，保证了Raft数据的一致性。每个日志包括序号和条目，条目包括任期号和指令。

##### 1）基础概念

###### ①前提

只有Leader节点能接受客户端的写请求，Leader向其他Follower转发请求日志，Leader不删除任何日志，Follower只接收Leader发送的日志信息。

###### ②大概流程

Leader收到指令后写入到本地日志，在随后的心跳中往其他追随者发送该条目，得到过半响应后把该条日志标志位设置为已提交状态，并发往状态机执行，返回结果给客户端。在之后的心跳包中通知follower哪些条目已经被提交。follower收到包后也把指令发往状态机执行。

###### ③特性1

Raft集群通过条目索引号、任期号唯一确定一个条目，任意节点，如果该条目相同，该条目之前的所有条目也相同，如果该条目已提交，之前所有的条目也已提交。

###### ④特性2

Leader发送的心跳包带有当前条目前序的索引和任期号，追随者只接受和自己条目相匹配的请求，如果找不到该条目则拒绝该请求，一旦follower接收了一个新的条目，说明两者的日志已经完全一致。

###### ⑤保证一致性

Raft处理日志不一致的情况是通过强制追随者复制领导者日志来调整日志一致性的，所以当追随者与领导者出现日志不一致时，追随者日志将会被领导者日志覆盖。

要让leader和follower日志保持一致，需要找到一致性的位置（最近的相同位置，利用**特性2**），删除之后的所有日志条目，然后leader发送那之后的日志给追随者。（具体如何发送，我理解是协议实现者自己控制量，因为leader端保存了状态）

leader给每一个follower维护了一个nextIndex，表示下一个需要发送给follower的日志条目索引地址。

###### ⑥初始化过程

leader刚赢得选举时，初始化所有nextIndex为自己的最新日志的index+1，当follower日志和leader日志不一致拒绝了包，那么下一次发送心跳包leader就会减少nextIndex的值重试，最后在某位置达成一致，冲突的位置会被leader的日志覆盖。

#### 6.成员变更

如果需要增加或减少成员，最方便安全的方法是关闭集群修改配置再重启。如果新机器直接加入集群，可能会出现脑裂问题，所以raft采用两阶段修改的功能。

##### 1）第一阶段

> 第一阶段称为joint consensus

日志被提交给新老配置所有的节点。
新旧配置中所有机器都可能成为leader。
选举和提交要在两种配置上获得超过半数的支持。
leader收到配置变更请求,C-old 到 C-new ，创建C-old-new的日志并复制给其他节点。follower以最新的配置做决定（包括新老节点）。

##### 2）第二阶段

> 第二阶段就是提交C-new

之后提交C-new到所有节点，提交完成后旧的配置就没用了。所有节点以新配置操作。

##### 其他细节

可以查看下面的链接。

#### 引用

> 分布式系统的RAFT算法：https://www.jdon.com/artichect/raft.html
>
> RAFT图解（缝合怪）：https://www.cnblogs.com/crazymakercircle/p/14343154.html
>
> RAFR日志追加：https://www.cnblogs.com/softlin/p/9537203.html
>
> 成员变更：http://ifeve.com/%E8%A7%A3%E8%AF%BBraft%EF%BC%88%E5%9B%9B-%E6%88%90%E5%91%98%E5%8F%98%E6%9B%B4%EF%BC%89/
> 			  ：https://blog.csdn.net/sky302761277/article/details/85318791

## 四.其他

2PC，3PC相关在SharingSphere那里的分布式事务处有记录。

