# 操作系统

## 1.硬件相关

### 图灵机

![image-20210716094730782](../images/image-20210716094730782-1626400051913.png)

图灵机主要功能就是读取纸带格⼦中的内容，然后交给控制单元识别字符是数字还是运算符指令，如果是数字则存⼊到图灵机状态中，如果是运算符，则通知运算符单元读取状态中的数值进⾏计算，计算结果最终返回给读写头，读写头把结果写⼊到纸带的格⼦中。

### 冯诺依曼模型

遵循了图灵机的设计，提出用电子元件构造计算机，约定了⽤⼆进制进⾏计算和存储，还定义计算机基本结构为 5 个部分，分别是中央处理器（CPU）、内存、输⼊设备、输出设备、总线。

![image-20210716091024224](../images/image-20210716091024224-1626397825485.png)

- **内存**

  数据存储的单位是⼀个⼆进制位（bit），即 0 或 1。最⼩的存储单位是字节（byte），1 字节等于 8 位。

- **中央处理器**（CPU）

  控制单元负责CPU工作，逻辑单元负责运算，寄存器种类多，作用不尽相同，CPU中的寄存器主要是存储计算时的数据，加快计算速度。

  常见的寄存器：

  - 通用寄存器：存放要运算的数据。
  - 程序计数器：用来存储CPU下一条要执行指令的内存地址
  - 指令寄存器：存放程序计数器指向的指令，指令被执行完前，都存储在这里。

- **总线**

  负责CPU和其他设备和内存之间的通信

  - 地址总线：指定CPU要操作的内存地址
  - 数据总线：读写内存数据
  - 控制总线：用于发送接收信号，比如中断等，CPU收到信号后进行响应。

  CPU读取数据需要先依靠地址总线指定内存地址，然后通过数据总线传输数据。

- 输入、输出设备

  输入输出设备向计算机输入数据，计算机计算后进行输出，如果输入设备是键盘，需要控制总线进行交互。

  

  

  **程序执行基本过程**

![image-20210716094906743](../images/image-20210716094906743-1626400148283.png)

简单总结⼀下就是，⼀个程序执⾏的时候，CPU 会根据程序计数器⾥的内存地址，从内存⾥⾯把需要执⾏的指令读取到指令寄存器⾥⾯执⾏，然后根据指令⻓度⾃增，开始顺序读取下⼀条指令。

### 存储器

![image-20210716095445214](../images/image-20210716095445214-1626400486055.png)

#### **CPUCache**

CPU Cache用的是SRAM（Static Random-Access Memory）的芯片，只要有电数据才能保持存在，1bit数据需要6个晶体管保存，存储密度不高但电路简单访问快。

- L1

  L1分为数据缓存和指令缓存，访问速度极快，通常只需要2-4个时钟周期，大小在几十KB到几百KB。

- L2

  通常几百KB到几MB不等，访问速度在10-20个时钟周期。

- L3

  CPU各核共享L3，大小在几MB到几十MB不等，访问速度在20-60个时钟周期。

##### 缓存数据结构

CPU Cache的数据是从内存中获取，是以Cache Line 为单位读取数据的。

```shell
#查看缓存块大小
cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size
```

对于读取的快，在内存中称为内存块，读取的时候需要拿到数据内存块的地址，**直接映射Cache**采用的策略是取模运算，运算的结果就是内存块地址对应的CPU Line的地址。还有全相连 Cache （*Fully Associative Cache*）、组相连 Cache（*Set Associative Cache*）等。

比如内存分32个内存块，CPU有8个CPU Line，要访问15号内存块，如果这内存块在缓存中，必在7号CPU Line中，15%8 = 7。为了区分不同的内存块，对应的CPU Line中会存储一个组标记Tag，记录当前CPU Line中存储数据对应的内存块。

CPU Line

- 组标记 TAG
- 具体数据
- 有效位，标记对应CPU Line中的数据是否有效，0代表无效。

CPU从CPU Cache读取数据时，不会读取整个数据块，而是读取一个片段，称为一个字Word，一个内存的访问地址包括：

- 组标记
- CPU Line索引
- 偏移量

![image-20210716102918624](../images/image-20210716102918624-1626402559879.png)

##### 缓存一致性

把CPU缓存中的数据写回内存的方式

- 写直达（Write Through）

  把数据同时写入内存和Cache。

- 写回（Write Back）

  发生写操作时，新的数据被写入缓存快中，只有当修改过的缓存块被替换时才需要写到内存中。

同步不同CPU核心的数据需要保证：

- 写传播

  （某个CPU核心的Cache更新，需要传播到其他核心）

写传播主要依靠总线嗅探机制实现，每次修改都把事件广播通知所有核心，每个核心都监听总线的广播事件。

- 事务串行化

  某个CPU核心里对数据的操作顺序，其他核心看来都是一样的。比如数据A，核心1改为100，核心2改为200，核心C看到数据从100变到200，核心D看到数据从200变到100，就不符合串行化。

MESI协议基于总线嗅探协议实现了事务的串行化，用状态机机制降低了总线压力。对已修改或独占状态的CPU Line 修改更新数据不需要发送广播。

- I  （Invalid）已失效
- E   (Exclusive) 独占
- S （Shared）共享
- M （Modified）已修改

CPU读：MES 都可以被读取 ，I只能从主内存读取。

CPU写：ME可以写，S写需要把其他CPU中的缓存置为无效才行。 然后这个设置过程可能会阻塞，为了避免阻塞带来的资源浪费，引入了store bufferes，写入共享数据直接写入buffer中，同时发送消息给其他CPU，最后再把缓存同步到主内存。 但这又会引发指令重排序。缓存还没刷新就执行后序指令。 因此CPU层面提供内存屏障，让软件层面可以决定在适当的地方插入内存屏障禁止指令重排序。

![image-20210716105732813](../images/image-20210716105732813-1626404253878.png)

#### **寄存器**

32位CPU大多数寄存器能存储4字节，64位能存储8字节。 访问速度非常快，一般要求在半个时钟周期完成读写，时钟周期和CPU主频相关，比如2GHZ主频的时钟周期是1/2G，即0.5ns。

1GHz的CPU，指的是时钟频率是1G，1秒会产生1G次数的脉冲信号，每次脉冲信号高低电平的转换就是一个周期，称为时钟周期。

#### **内存**

内存⽤的芯⽚和 CPU Cache 有所不同，它使⽤的是⼀种叫作 DRAM （Dynamic Random Access Memory，动态随机存取存储器） 的芯⽚。晶体密度更高，功耗更低，造价便宜，存储一个bit数据只要一个晶体管和一个电容，因为数据存储在电容，电容会不断漏电，所以要定时刷新电容才能保证数据不丢失，所以叫动态存储器，访问速度在200-300个时钟周期之间。

#### **SSD**/**HDD**

SSD结构和内存类似，但断电后数据会保留，内存读写速度大概是SSD的10-1000倍。 机械硬盘访问速度比内存慢10W倍左右。

#### **访问过程**

另外，当 CPU 需要访问内存中某个数据的时候，如果寄存器有这个数据，CPU 就直接从寄存器取数据即可，如果寄存器没有这个数据，CPU 就会查询 L1 ⾼速缓存，如果 L1 没有，则查询 L2 ⾼速缓存，L2 还是没有的话就查询 L3 ⾼速缓存，L3 依然没有的话，才去内存中取数据。

```shell
 #index0、1、2、3分别代表L1数据 L1指令 L2 L3缓存
 cat /sys/devices/system/cpu/cpu0/cache/index?/size
```

