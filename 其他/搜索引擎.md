### Elasticsearch概念总结

#### 1.特点

1. 擅长模糊搜索。
2. 搜索根据评分过滤大部分数据，只返回评分高的数据给用户。
3. 没有那么准确的关键字也能搜索处结果（匹配相关性记录）

#### 2.数据结构

##### 1.正向索引

根据完整的条件查询一条记录，比如通过目录找页码。

##### 2.倒排索引

通过某个不完整的条件，查找对应的记录。 ES就是通过分词，分词后快速找出相关结果来实现模糊查询。

###### 1.分词器

中文一般IK分词器用的多。先文本过滤，再按规则切分，再对切分后的词进行处理。

##### 3.具体结构

输入一段文字，ES会根据分词器先分词，分词后放入Term Dictionary,可以通过分词找到对应的记录，文档id保存在PostingList。Term Dictionary中的词会进行排序，目的是为了使用二分加快查找顺序。因为词语较多，所以es还抽出一层叫Term Index，这部分只存储词语的前缀,term index会存在内存中，加快检索速度。term index在内存中以FST的形式保存，特点是节省内存。查询效率高。postinglist使用FOR编码技术对数据压缩以节约空间。查询时对文档id使用**Roaring Bitmaps**做交集和并集操作。

#### 3.术语架构

index	表

document	行

field	列

DSL	相当于SQL

##### 1.集群架构

- 一个集群有很多节点，其中有个主节点，负责维护索引元数据，切换主分片副本分片的身份工作。 ES最外层是index，即表，一个Index的数据可能很多，为了性能可以分发到不同的节点存储，这个操作称为分片。 

- 为了保证可靠性，分片一般有主分片副分片之分，数据写入是写到主分片，副本分片会复制主分片的数据，读取时所有分片都能读。主分片挂了主节点会把其副本分片提拔为主分片。
- 集群上每个节点都是协调节点，都能进行路由，写数据时通过hash找到应该写入到哪个主分片。

##### 2.写入读取过程

###### 1.写入过程

1. 先把数据写入内存缓存区。
2. 把数据写入到translog缓存区。
3. 每隔1s把数据从内存缓存区，然后刷新到文件系统缓存中，再生成segment文件，生成文件后就能通过索引查到该插入的数据。
4. 刷新完，内存缓存区就清空了，然后每隔5s，translog从缓存刷回磁盘（节点挂了可能有5s数据丢失）。
5. 定期/定量从文件系统缓存结合translog内容刷新会磁盘中。
6. translog文件过大或者时间超过30分钟,会触发commit操作，把内存中的segement文件异步刷新回磁盘完成持久化。

主分片写完内容后，会把数据并行发给副本集节点，等所有节点写入成功就返回ack给协调节点，然后协调节点返回ack给客户端。

###### 2.更新和删除

会给对应的文档记录打上.delete标识，如果是更新就是先给原来的文档打上delete标识再重新写入新数据。 因为每隔1s生成一个segement文件，文件会越来越多，es会有一个merge任务，把多个segement合并成一个文件，合并时会删除被打上删除标记的文档。

#### 4.查询过程

##### 1.根据ID查询doc

- 检查内存translog文件，检查硬盘的translog文件，检查硬盘的segement文件。

##### 2.根据query去匹配doc

- 同时查询内存和硬盘的segment文件（因为每隔1s生成，所以有延迟）

##### 3.查询方式

###### 1.一阶段（QUERY_AND_FETCH）

query fetch(查询完就返回整个doc内容)

###### 2.二阶段（QUERY_THEN_FETCH）

query	到	fetch（先查询出对应的Doc id ，然后再根据Doc id 匹配去对应的文档）

###### 3.三阶段（DFS_QUERY_THEN_FETCH）

DFS	到	query	到	fetch（（先算分，再查询），分代表文档和词出现的频率，频率越高，相关性越强）

query:协调节点向目标分片发送查询命令，即转发请求。 数据节点过滤排序等操作数据后，返回doc id给协调节点

fetch:协调节点对doc id聚合，向目标数据分片发送抓取命令，获取doc记录，数据节点按协调节点发送的doc id返回实际需要的数据给协调节点。

总而言之，因为es是分布式的，从各个节点拉取对应的数据然后统一合成给客户端。

##### 4.具体流程

- 客户端请求发送到集群的某个节点上。集群上的每个节点都是coordinate node（协调节点）
- 然后协调节点将搜索的请求转发到**所有分片上**（主分片和副本分片都行）
- 每个分片将自己搜索出的结果`(doc id)`返回给协调节点，由协调节点进行数据的合并、排序、分页等操作，产出最终结果。
- 接着由协调节点根据 `doc id` 去各个节点上**拉取实际**的 `document` 数据，最终返回给客户端。

#### 参考文章

3y:https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&mid=2247486522&idx=1&sn=7b6080756d0711c646fb47d5db49fc97&chksm=ebd74d3bdca0c42d35f7eef97e4f925a20cc82b07ca7aeba21f83ba56135ab2dd1ad73238b72&token=1963867963&lang=zh_CN#rd